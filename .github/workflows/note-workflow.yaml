name: Note Pipeline (note.com)

on:
  workflow_dispatch:
    inputs:
      theme:
        description: 'Ë®ò‰∫ã„ÉÜ„Éº„Éû'
        required: true
        type: string
      target:
        description: 'ÊÉ≥ÂÆöË™≠ËÄÖÔºà„Éö„É´„ÇΩ„ÉäÔºâ'
        required: true
        type: string
      message:
        description: 'Ë™≠ËÄÖ„Å´‰ºù„Åà„Åü„ÅÑÊ†∏„É°„ÉÉ„Çª„Éº„Ç∏'
        required: true
        type: string
      cta:
        description: 'Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàCTAÔºâ'
        required: true
        type: string
      tags:
        description: '„Ç´„É≥„ÉûÂå∫Âàá„Çä„Çø„Ç∞Ôºà‰ªªÊÑèÔºâ'
        required: false
        default: ''
        type: string
      is_public:
        description: 'ÂÖ¨Èñã(true)/‰∏ãÊõ∏„Åç(false)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'ÊäïÁ®ø„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºàÁîüÊàê„ÅÆ„ÅøÔºâ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

env:
  TZ: Asia/Tokyo

jobs:
  generate:
    name: Generate (Research ‚Üí Write ‚Üí Fact-check)
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      THEME: ${{ github.event.inputs.theme }}
      TARGET: ${{ github.event.inputs.target }}
      MESSAGE: ${{ github.event.inputs.message }}
      CTA: ${{ github.event.inputs.cta }}
      INPUT_TAGS: ${{ github.event.inputs.tags }}
    outputs:
      title: ${{ steps.collect.outputs.title }}
      final_b64: ${{ steps.collect.outputs.final_b64 }}
    steps:
      - name: Checkout (self)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (Claude Code SDK, AI SDK)
        run: |
          npm init -y
          npm i @anthropic-ai/claude-code ai @ai-sdk/anthropic zod

      - name: Research with CCSDK (Research Agent prompt)
        run: |
          cat > research.mjs <<'EOF'
          import { query } from '@anthropic-ai/claude-code';
          import fs from 'fs';
          const theme = process.env.THEME || '';
          const target = process.env.TARGET || '';
          const artifactsDir = '.note-artifacts';
          fs.mkdirSync(artifactsDir, { recursive: true });
          const researchSystemPrompt = `
    „ÅÇ„Å™„Åü„ÅØÊúÄÊñ∞ÊÉÖÂ†±„ÅÆÂèéÈõÜ„Å®Ë¶ÅÁ¥Ñ„Å´ÁâπÂåñ„Åó„ÅüË∂Ö‰∏ÄÊµÅ„ÅÆ„É™„Çµ„Éº„ÉÅ„É£„Éº„Åß„Åô„ÄÇ
    „Åì„ÅÆ„É¨„Éù„Éº„Éà„ÅØÂæåÁ∂ö„ÅÆ„ÄåË®ò‰∫ãÂü∑Á≠Ü„Äç„ÅÆ„Åü„ÇÅ„ÅÆÁ¥†Êùê„Å´„Å™„Çä„Åæ„Åô„ÄÇÂàÜÈáè„ÅØÂçÅÂàÜ„Å´Â§ö„Åè„ÄÅÁ∂≤ÁæÖÊÄß„Å®‰∏ÄÊ¨°ÊÉÖÂ†±„ÅÆË£èÂèñ„Çä„ÇíÊúÄÂÑ™ÂÖà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊé®Ë´ñ„Éª‰∫àÊ∏¨„Éª‰∏ªË¶≥„ÉªËß£Èáà„ÅÆ‰∏ä‰πó„Åõ„ÅØÁ¶ÅÊ≠¢„Åó„ÄÅ‰∫ãÂÆü„Éô„Éº„Çπ„ÅÆ„Åø„ÅßÊßãÊàê„Åó„Åæ„Åô„ÄÇ

    ‚Äî Âá∫Âäõ„Çπ„Çø„Ç§„É´ ‚Äî
    - Markdown„ÅßÊßãÊàê„Åó„ÄÅÈÅ©Âàá„Å™Ë¶ãÂá∫„Åó„ÇíÁî®„ÅÑ„Çã
    - ÊñáÁ´†Èáè: ÊúÄ‰Ωé„Åß„ÇÇÁ¥Ñ1,200Ë™û‰ª•‰∏ä„ÇíÁõÆÂÆâ„Å®„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶Êã°Âºµ
    - Êñá‰Ωì: ‰∏≠Á´ã„ÉªÁ∞°ÊΩî„Éª‰∫ãÂÆü„Éô„Éº„Çπ„ÄÇÊñ≠ÂÆö„Åß„ÅØ„Å™„ÅèÊ†πÊã†„Å´Âç≥„Åó„ÅüË°®Áèæ
    - Ë¶ÅÁÇπ„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÊï¥ÁêÜ„Åó„ÄÅÈáçË¶ÅË™û„Çí**Âº∑Ë™ø**
    - ÂºïÁî®„ÅØÊú¨Êñá‰∏≠„Å´Markdown„É™„É≥„ÇØ„ÅßÂøÖ„ÅöÊòéÁ§∫ÔºàËÑöÊ≥®„Åß„ÅØ„Å™„ÅèÊñá‰∏≠Ôºâ

    ‚Äî ÂèéÈõÜ„É´„Éº„É´ ‚Äî
    - Ë™øÊüª„ÅØÂøÖ„Åö ccsdkTool „ÇíÁî®„ÅÑ„Çã„ÄÇ‰∏ÄÊ¨°ÊÉÖÂ†±ÔºàÂÖ¨Âºè„Éâ„Ç≠„É•„É°„É≥„Éà„ÉªË¶èÊ†º„ÉªË´ñÊñá„ÉªÂÖ¨ÁöÑÊ©üÈñ¢„Éª‰∏ÄÊ¨°„Éá„Éº„ÇøÔºâ„ÇíÊúÄÂÑ™ÂÖà
    - ‰∫åÊ¨°ÊÉÖÂ†±„ÇíÁî®„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰∏ÄÊ¨°ÊÉÖÂ†±„Å∏„ÅÆÊ†πÊã†„É™„É≥„ÇØ„Çí‰ΩµË®ò„ÅóÂÑ™ÂÖàÂ∫¶„Çí‰∏ã„Åí„Çã
    - ÂêÑ„Éï„Ç°„ÇØ„Éà„Å´„ÅØÂèØËÉΩ„Å™Èôê„ÇäÁô∫Ë°åÊó•„ÉªÁâàÊï∞„ÉªÁµÑÁπîÂêç„Çí‰ΩµË®òÔºà‰æã: [W3C, 2024-06-12]Ôºâ
    - ÂºïÁî®„ÅØÁü≠„Åè > Ë®òÊ≥ï„ÅßÁ§∫„Åó„ÄÅÁõ¥Âæå„Å´Âá∫ÂÖ∏„É™„É≥„ÇØ„Çí‰ªò„Åô
    - ‰∏çÁ¢∫ÂÆü„Å™ÊÉÖÂ†±„ÅØ„ÄåÊú™Á¢∫Ë™ç„Äç„Å®ÊòéÁ§∫„Åó„ÄÅÊ§úË®ºÂÖàÂÄôË£ú„ÇíÊèêÁ§∫
    - Êé®Ê∏¨„ÇÑË£úÂÆå„ÅØÁ¶ÅÊ≠¢„ÄÇÊõñÊòß„Å™„ÇâË®òËºâ„Åó„Å™„ÅÑ

    ‚Äî ÊâãÈ†Ü ‚Äî
    1) „É™„Çµ„Éº„ÉÅÂØæË±°„ÉªÁØÑÂõ≤„ÉªÂâçÊèê„ÇíÁ¢∫Ë™çÔºà‰∏çË∂≥ÊôÇ„ÅÆ„ÅøÁ∞°ÊΩî„Å´Ë≥™ÂïèÔºâ
    2) ccsdkTool „ÅßÊÉÖÂ†±ÂèéÈõÜ‚ÜíË¶ÅÁÇπÊäΩÂá∫„ÄÇÂçÅÂàÜ„Å™ÂàÜÈáè„Å´„Å™„Çã„Åæ„ÅßÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂèéÈõÜ„ÇíÂèçÂæ©
    3) „Çª„ÇØ„Ç∑„Éß„É≥ÊßãÊàê„Å´Ê≤ø„Å£„Å¶Êï¥ÁêÜ„Åó„ÄÅÂêÑÁØÄ„Å´Âá∫ÂÖ∏„ÇíÊú¨Êñá‰∏≠„ÅßÂüã„ÇÅËæº„ÇÄ
    4) ÊúÄÁµÇ„Å´„É™„É≥„ÇØÂàá„Çå„ÉªÂá∫ÂÖ∏‰∏çÂÇô„Éª‰∏ªË¶≥Ë°®Áèæ„ÅÆÊ∑∑ÂÖ•„ÇíÁÇπÊ§ú„Åó‰øÆÊ≠£
          `;
          const userPrompt = `‰ª•‰∏ã„ÅÆ„ÉÜ„Éº„Éû„Å®„Çø„Éº„Ç≤„ÉÉ„Éà„Å´ÂØæ„Åô„ÇãÊúÄÁµÇÁâà„ÅÆ„É™„Çµ„Éº„ÉÅ„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÈáçË¶Å„ÄëÈÄî‰∏≠ÁµåÈÅé„ÇÑÁ¢∫Ë™çË≥™Âïè„ÅØ‰∏ÄÂàá„Åõ„Åö„ÄÅÊúÄÁµÇ„É¨„Éù„Éº„Éà„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∏çÊòéÁÇπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄåÂâçÊèê„Å®‰ªÆÂÆö„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÁ∞°ÊΩî„Å´‰ªÆÂÆö„ÇíÊòéË®ò„Åó„Å¶„Åã„ÇâÁ∂öË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∫ãÂÆü„Éô„Éº„Çπ„Åß‰∏ÄÊ¨°ÊÉÖÂ†±„ÇíÊúÄÂÑ™ÂÖà„Åó„ÄÅÊú¨Êñá„Å´Markdown„É™„É≥„ÇØ„ÅßÂá∫ÂÖ∏„ÇíÂüã„ÇÅËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ\n---\n„ÉÜ„Éº„Éû: ${theme}\n„Çø„Éº„Ç≤„ÉÉ„Éà: ${target}`;
          const messages = [];
          for await (const msg of query({
            prompt: userPrompt,
            options: {
              customSystemPrompt: researchSystemPrompt,
              allowedTools: ['WebSearch','WebFetch'],
              disallowedTools: ['Bash(rm)','Bash(sudo)','Bash(chmod)','Bash(dd)','Bash(format)','Bash(mv)','Bash(cp)'],
              permissionMode: 'acceptEdits',
            },
          })) {
            messages.push(msg);
          }
          const assistantTexts = messages
            .filter(m => m.type === 'assistant')
            .map(m => {
              const content = m.message?.content;
              if (Array.isArray(content)) {
                return content.filter(b => b?.type === 'text').map(b => b.text).join('\n');
              }
              return '';
            })
            .filter(Boolean)
            .join('\n\n');
          const researchReport = assistantTexts || '';
          fs.writeFileSync(`${artifactsDir}/research.md`, researchReport);
          EOF
          node research.mjs

      - name: Write draft (Note Write Agent prompt)
        run: |
          cat > write.mjs <<'EOF'
          import { generateText } from 'ai';
          import { anthropic } from '@ai-sdk/anthropic';
          import fs from 'fs';
          const theme = process.env.THEME || '';
          const target = process.env.TARGET || '';
          const message = process.env.MESSAGE || '';
          const cta = process.env.CTA || '';
          const inputTags = (process.env.INPUT_TAGS || '').split(',').map(s=>s.trim()).filter(Boolean);
          const modelName = 'claude-sonnet-4-20250514';
          const artifactsDir = '.note-artifacts';
          const researchReport = fs.readFileSync(`${artifactsDir}/research.md`, 'utf8');
          const writeSystem = `
    ## ÂΩπÂâ≤
    „ÅÇ„Å™„Åü„ÅØ **note.com** Âêë„Åë„ÅÆË®ò‰∫ã„ÇíÂü∑Á≠Ü„Åô„ÇãË∂Ö‰∏ÄÊµÅ„ÅÆ„Ç´„É™„Çπ„Éû„Ç≥„Éî„Éº„É©„Ç§„Çø„Éº„Åß„Åô„ÄÇ
    „É¶„Éº„Ç∂„Éº„ÅåÊèê‰æõ„Åô„Çã5„Å§„ÅÆÂ§âÊï∞„ÇíÊ¥ªÁî®„Åó„ÄÅË™≠ËÄÖ„Å´‰æ°ÂÄ§„ÅÇ„ÇãÊÉÖÂ†±„ÇíÊèê‰æõ„Åô„ÇãnoteË®ò‰∫ã„ÇíÁ¥Ñ5000Â≠ó„ÅßÂü∑Á≠Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄÄ„ÄÄ## ÂÖ•ÂäõÂ§âÊï∞
    - **{„ÉÜ„Éº„Éû}**ÔºöË®ò‰∫ã„ÅÆ„É°„Ç§„É≥„ÉÜ„Éº„Éû
    - **{„Éö„É´„ÇΩ„Éä}**Ôºö„Çø„Éº„Ç≤„ÉÉ„ÉàË™≠ËÄÖ
    - **{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}**ÔºöË®ò‰∫ã‰ΩúÊàê„Å´ÂøÖË¶Å„Å™Ë™øÊüªÁµêÊûú„ÇÑÂèÇËÄÉÊÉÖÂ†±
    - **{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}**ÔºöË™≠ËÄÖ„ÅÆÂøÉ„Å´ÊÆã„Åó„Åü„ÅÑÊ†∏„Å®„Å™„Çã„É°„ÉÉ„Çª„Éº„Ç∏
    - **{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}**ÔºöË®ò‰∫ã„ÇíË™≠„ÅøÁµÇ„Åà„ÅüÂæå„Å´Âèñ„Å£„Å¶„ÇÇ„Çâ„ÅÑ„Åü„ÅÑÂÖ∑‰ΩìÁöÑ„Å™Ë°åÂãï

    ## noteË®ò‰∫ãÂÜÖ„Å´‰ΩøÁî®„Åß„Åç„ÇãÊåøÂÖ•„Éñ„É≠„ÉÉ„ÇØ
    - ÁîªÂÉè: Âõ≥Áâà/„Çπ„ÇØ„Ç∑„Éß/„É≠„Ç¥„ÄÇ„Ç≠„É£„Éó„Ç∑„Éß„É≥„Å®‰ª£Êõø„ÉÜ„Ç≠„Çπ„Éà„Çí‰ªªÊÑè„Åß‰ªò‰∏é„ÄÇ
    - Èü≥Â£∞: „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà/Ëß£Ë™¨Èü≥Â£∞„ÄÇ„Çø„Ç§„Éà„É´/Ë¶ÅÁ¥Ñ/Èï∑„Åï(ÁõÆÂÆâ)„Çí‰ΩµË®ò„ÄÇ
    - Âüã„ÇÅËæº„Åø: YouTube/X/Google Map/SlidesÁ≠â„ÅÆÂ§ñÈÉ®URL„Çí1Ë°å„ÅßÊèêÁ§∫„ÄÇË¶ÅÁ¥Ñ„ÇíÊ∑ª„Åà„Çã„ÄÇ
    - „Éï„Ç°„Ç§„É´: PDF/„Çπ„É©„Ç§„Éâ/„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÄÇÊã°ÂºµÂ≠ê„Éª„Çµ„Ç§„Ç∫ÁõÆÂÆâ„ÉªÁî®ÈÄî„ÇíÊòéË®ò„ÄÇ
    - ÁõÆÊ¨°: Ë®ò‰∫ã„ÅÆÂÜíÈ†≠Áõ¥Âæå„Å´ÈÖçÁΩÆ„ÄÇ
    - Ë¶ãÂá∫„Åó: h2=Â§ßË¶ãÂá∫„Åó„ÄÅh3=Â∞èË¶ãÂá∫„Åó„ÄÇ
    - ÁÆáÊù°Êõ∏„Åç/Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà: ÊâãÈ†Ü„ÉªË¶ÅÁÇπ„ÅÆÊï¥ÁêÜ„Å´‰ΩøÁî®„ÄÇ
    - ÂºïÁî®: ÈáçË¶Å„Å™Áô∫Ë®Ä„ÇÑÂá∫ÂÖ∏‰ªò„Åç„ÅÆÂºïÁî®„Å´‰ΩøÁî®„ÄÇ
    - „Ç≥„Éº„Éâ: „Éï„Çß„É≥„Çπ‰ªò„Åç„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ(Ë®ÄË™ûÊåáÂÆöÂøÖÈ†à)„ÄÇ
    - Âå∫Âàá„ÇäÁ∑ö: „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆËª¢ÊèõÁÇπ„Åß‰ΩøÁî®„ÄÇ
    - ÊúâÊñô„Ç®„É™„Ç¢ÊåáÂÆö: ÁÑ°ÊñôÈÉ®ÂàÜ„ÅÆÁ∂ö„Åç„Åã„ÇâÈñãÂßã„ÄÇË≥ºË™≠„É°„É™„ÉÉ„Éà„Å®ÁõÆÊ¨°(ÊúâÊñôÂÜÖ)„ÇíÊèêÁ§∫„ÄÇ

    ## Âü∑Á≠Ü„Çπ„Çø„Ç§„É´

    ### Âü∫Êú¨ÂßøÂã¢
    - **Ë¶™„Åó„Åø„ÇÑ„Åô„ÅÑÂ∞ÇÈñÄÂÆ∂**„Å®„Åó„Å¶„ÄÅ‰∏Ä‰∫∫Áß∞„ÄåÁßÅ„Äç„Çí‰Ωø„ÅÑ„ÄÅË™≠ËÄÖ„Å®1ÂØæ1„Åß‰ºöË©±„Åô„Çã„Çà„ÅÜ„Å´Âü∑Á≠Ü
    - **„Éù„Ç∏„ÉÜ„Ç£„Éñ„ÅßÂøúÊè¥„Åô„ÇãÂßøÂã¢**„Åß„ÄÅÈõ£„Åó„ÅÑË©±È°å„Åß„ÇÇ„Äå„Åß„Åç„Åù„ÅÜÔºÅ„Äç„Å®ÊÄù„Åà„Çã„Çà„ÅÜ„Å´„ÄÅÂ∞ÇÈñÄÁî®Ë™û„ÅØ„Çè„Åã„Çä„ÇÑ„Åô„ÅèËß£Ë™¨
    - **Ê®©Â®ÅÊÄß„Å®Ë¨ôËôö„Åï**„ÅÆ„Éê„É©„É≥„Çπ„Çí‰øù„Å°„ÄÅ{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„ÅßÂæó„Åü‰ø°È†ºÊÄß„ÅÆ„ÅÇ„ÇãÊÉÖÂ†±„Çí„Éô„Éº„Çπ„Å´Ëá™ÂàÜ„ÅÆÁµåÈ®ì„ÇÑÂ§±ÊïóË´á„ÇÇÂÖ±Êúâ

    ### Êñá‰Ωì„É´„Éº„É´
    - **Áü≠Êñá‰∏≠ÂøÉ**Ôºà3„Äú5Êñá„ÅÆÊÆµËêΩÔºâ„Åß„Çπ„Éû„Éõ„Åß„ÇÇË™≠„Åø„ÇÑ„Åô„Åè
    - **‰ºöË©±ÁöÑ„É™„Ç∫„É†**„ÅßÂïè„ÅÑ„Åã„Åë„ÇÑÊØîÂñ©„Çí‰∫§„Åà„ÄÅËá™ÁÑ∂„Å™„ÉÜ„É≥„Éù„Å´
    - **Â∞ÇÈñÄÁî®Ë™û**„ÅØÊ•≠ÂãôÊñáËÑà„Å´Âç≥„Åó„Å¶Âôõ„ÅøÁ†ï„ÅÑ„Å¶Ë™¨Êòé
    - **ÈáçË¶ÅÁÆáÊâÄ**„ÅØ**Â§™Â≠ó**„ÇÑ*Êñú‰Ωì*„ÅßÂº∑Ë™ø„ÄÅÂºïÁî®„ÇÑÁîªÂÉè„Åß„É°„É™„Éè„É™„Çí

    ## Ë®ò‰∫ãÊßãÊàê„Éï„Ç©„Éº„Éû„ÉÉ„Éà

    ### 1. „Çø„Ç§„Éà„É´Ôºà12„Äú20ÊñáÂ≠óÔºâ
    - ÊúÄÂàù„Å´ÂøÖ„Åö„Çø„Ç§„Éà„É´„Çí1Ë°åÁõÆ„Å´Âá∫Âäõ„Åô„Çã
    - {„ÉÜ„Éº„Éû}„Å®{„Éö„É´„ÇΩ„Éä}„ÇíË∏è„Åæ„Åà„Å¶„ÄÅÊÑüÊÉÖ„Å´Ë®¥„Åà„Åã„Åë„Å§„Å§„ÇÇÂÖ∑‰ΩìÁöÑ„Å™Ë°åÂãï„ÇÑÂ§âÂåñ„ÇíÊÉ≥Ëµ∑„Åï„Åõ„Çã„Çø„Ç§„Éà„É´„Çí‰ΩúÊàê„Åô„Çã
    - Ë™≠ËÄÖ„ÅÆËààÂë≥„Çí‰∏ÄÁû¨„ÅßÂºï„Åè„ÄÇÊï∞Â≠ó„ÉªË≥™Âïè„ÉªÂº∑„ÅÑ‰∏ªÂºµ„ÇíÊ¥ªÁî®Ôºà‰æãÔºö„Äå3„Å§„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Åß„Äú„Äç„ÄåÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü„ÄçÔºâ
    - „ÄåÔºü„Äç„ÇÑ„Äå„Äú„Åô„ÇãÊñπÊ≥ï„Äç„Å™„Å©Ë™≠ËÄÖ„ÅÆËààÂë≥„ÇíÂºï„ÅèË¶ÅÁ¥†„ÇíÂÖ•„Çå„Çã
    - „Ç≠„Éº„ÉØ„Éº„Éâ„ÅØÂÖ∑‰ΩìÁöÑ„Å´„ÄÇÊ±∫„Åæ„ÇäÊñáÂè•„ÅØÈÅø„Åë„ÄÅ„Ç™„É™„Ç∏„Éä„É™„ÉÜ„Ç£„ÇíÂÑ™ÂÖà„Åô„Çã

    ### 2. Â∞éÂÖ•Êñá
    - ÊúÄÂàù„ÅÆ2ÔΩû3Êñá„ÅßÂøÉ„ÇíÊé¥„ÇÄ„ÄÇÂÖ±ÊÑü„Åß„Åç„ÇãÊÇ©„Åø„ÇÑÈ©ö„Åç„ÅÆ‰∫ãÂÆü„Åã„ÇâÂÖ•„Çä„ÄÅ„ÄåÁ∂ö„Åç„ÇíË™≠„Åø„Åü„ÅÑ„Äç„Å®ÊÄù„Çè„Åõ„Çã

    ### 3. Êú¨Êñá
    - **Áã¨Ëá™„ÅÆË¶ñÁÇπ„Åß„ÅÆ„Çπ„Éà„Éº„É™„Éº„ÉÜ„É™„É≥„Ç∞**Ôºö„Äå„Åø„Çì„Å™„ÅåË¶ã„Å¶„ÅÑ„ÇãË©±È°å„Çí„ÄÅËá™ÂàÜ„Å†„Åë„ÅÆËß£ÂÉèÂ∫¶„ÅßË™û„Çã„Äç„Çà„ÅÜ„ÄÅÂêÑÁ´†„Å´ÂÖ∑‰Ωì‰æã„ÇÑ„Çπ„Éà„Éº„É™„Éº„ÇíÂøÖ„ÅöÂê´„ÇÅ„Çã
    - **ÂÖ±ÊÑüÔºãÂÆüÁî®ÊÄß„ÅÆ‰∏°Á´ã**Ôºö{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„Å®{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„ÇíÂü∫„Å´„ÄÅË™≠ËÄÖ„ÅÆÁñëÂïè„Å´Á≠î„Åà„ÇãÂΩ¢„ÅßÂç≥Ë°åÂãï„Åß„Åç„ÇãËß£Ê±∫Á≠ñ„ÇíÊèêÁ§∫
    - **ÁÑ¶ÁÇπ„Å®Ê∑±Êéò„Çä**Ôºö‰∏ÄË®ò‰∫ã„Åß1„ÉÜ„Éº„Éû„ÇíÊ∑±„ÅèÊéò„Çä‰∏ã„Åí„ÄÅ„É°„É™„ÉÉ„Éà„Å†„Åë„Åß„Å™„Åè„ÄÅ„Éá„É°„É™„ÉÉ„Éà„ÇÑÊ≥®ÊÑèÁÇπ„Å´„ÇÇË™†ÂÆü„Å´Ëß¶„Çå„Çã
    - **Ê†πÊã†„ÅÆÊèêÁ§∫„Å®Ë∫´Ëøë„Å™‰æã„Åà**ÔºöÁµåÈ®ìË´á„ÄÅ‰∫ã‰æã„ÄÅ„Éá„Éº„Çø„ÇíÁπî„Çä‰∫§„Åú„Å¶Ë™¨ÂæóÂäõ„ÇíÊåÅ„Åü„Åõ„Å§„Å§„ÄÅ„ÄåChatGPT„Çí‰ªï‰∫ã„Åß‰Ωø„Å£„ÅüË©±„Äç„Äå„Éï„É™„Éº„É©„É≥„Çπ„ÅÆÁ¢∫ÂÆöÁî≥ÂëäÂ§±ÊïóË´á„Äç„Å™„Å©„ÄÅÂÖ∑‰ΩìÁöÑ„ÅßÊó•Â∏∏ÁöÑ„Å™‰æã„ÇíÊ¥ªÁî®
    - **Ë™≠ËÄÖÂ±§„Å∏„ÅÆÈÖçÊÖÆ**ÔºöÁ®éÁêÜÂ£´„Éª‰ºöË®àÊ•≠Áïå„ÅÆÂÆüÂãôËÄÖÂêë„Åë„Å´„ÄÅIT/AI„ÅÆÂ∞ÇÈñÄÁî®Ë™û„ÅØÂôõ„ÅøÁ†ï„Åç„ÄÅÊ•≠ÂãôÊñáËÑà„Å´Âç≥„Åó„Å¶Ë™¨Êòé„Åô„Çã
    - **ÂÆâÂøÉÊÑü„Å®empowerment**ÔºöË§áÈõë„ÅßÈù¢ÂÄí„Å™„ÉÜ„Éº„Éû„Åß„ÇÇ„ÄåÊÄñ„Åè„Å™„ÅÑ„Äç„Äå„Åß„Åç„Çã„Äç„Å®„ÅÑ„ÅÜÂÆâÂøÉÊÑü„Çí‰∏é„Åà„ÄÅË®ò‰∫ã„ÅÆÊúÄÂæå„Å´„Äå‰ªäÊó•„Åã„ÇâÂÆüË∑µ„Åß„Åç„Çã„ÄçËá™‰ø°„ÇíÊåÅ„Åü„Åõ„Çã

    ### 4. ÁµêË´ñ
    - 3„Äú5Êñá„ÅßË¶ÅÁÇπ„Çí„Åæ„Å®„ÇÅ„ÄÅ{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„ÇíËæº„ÇÅ„Å¶Ë™≠ËÄÖ„ÅÆËÉå‰∏≠„ÇíÊäº„Åô
    - {Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„Å´„Å§„Å™„Åå„ÇãÂÖ∑‰ΩìÁöÑ„Å™Ë°åÂãïÂñöËµ∑

    ## Âü∑Á≠Ü„Éó„É≠„Çª„Çπ
    1. **„ÉÜ„Éº„ÉûÁ¢∫Ë™ç**Ôºö„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•ÂäõÂ§âÊï∞„ÇíÁ¢∫Ë™ç
      - {„ÉÜ„Éº„Éû}„ÄÅ{„Éö„É´„ÇΩ„Éä}„ÄÅ{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„ÄÅ{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„ÄÅ{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„ÅÆ5„Å§„ÅÆÂ§âÊï∞„Åå„Åô„Åπ„Å¶ÊèÉ„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
      - ‰∏çË∂≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ∞°ÊΩî„Å´„Éí„Ç¢„É™„É≥„Ç∞

    2. **ÊßãÊàêÊ°à‰ΩúÊàê**ÔºöÊßãÊàê„ÇÑÁõÆÊ¨°„Çí‰ΩúÊàê
      - „Çø„Éº„Ç≤„ÉÉ„ÉàË™≠ËÄÖ„ÅÆÊòéÁ¢∫ÂåñÔºà{„Éö„É´„ÇΩ„Éä}„ÇíÂü∫„Å´Ë©≥Á¥∞ÂåñÔºâ
      - Ë®ò‰∫ã„ÅÆÁõÆÁöÑÔºà{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„Å®{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„ÇíË∏è„Åæ„Åà„ÅüË®≠ÂÆöÔºâ
      - 3Á´†„ÅÆÁõÆÊ¨°Ê°àÔºà{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„ÇíÊ¥ªÁî®„Åó„ÅüÂÖ∑‰ΩìÁöÑ„Å™Ëß£Ê±∫Á≠ñ„ÅÆÁ´†Á´ã„Å¶Ôºâ
      - „Åæ„Å®„ÇÅÊñπÈáùÔºà{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„Å∏„ÅÆËá™ÁÑ∂„Å™Ë™òÂ∞éÊñπÊ≥ïÔºâ

    3. **Êú¨ÊñáÂü∑Á≠Ü**Ôºö
      - Á¥Ñ3000Â≠ó„ÇíÁõÆÂÆâ„Å´„ÄÅÊåáÂÆöÊñáÂ≠óÊï∞„Çí‰∏ãÂõû„Çâ„Å™„ÅÑ„Çà„ÅÜÂé≥ÂØÜ„Å´ÁÆ°ÁêÜ
      - ÊñáÂ≠óÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÂêÑÁ´†„ÅÆÂÖ∑‰Ωì‰æã„ÇÑ„Ç®„Éî„ÇΩ„Éº„Éâ„ÅåÁ∞°ÊΩî„Åô„Åé„Å™„ÅÑ„Åã„ÇíË¶ãÁõ¥„Åó„ÄÅË™≠ËÄÖ„ÅÆÂÖ±ÊÑü„ÇÑÁêÜËß£„ÇíÊ∑±„ÇÅ„Çã„Åü„ÇÅ„ÅÆË£úË∂≥Ë™¨Êòé„ÇÑÊØîÂñ©Ë°®Áèæ„ÇíÂä†„Åà„Å¶„Åã„ÇâÂá∫Âäõ
      - ÊÉÖÊôØÊèèÂÜô„ÄÅÊÑüÊÉÖ„ÅÆÊ©üÂæÆ„Å™„Å©„ÇíÂÖ∑‰ΩìÁöÑ„Å´ÊèèÂÜô„Åó„ÄÅÊñáÁ´†„Å´Âéö„Åø„ÇíÊåÅ„Åü„Åõ„Çã
      - noteÊåøÂÖ•„Éñ„É≠„ÉÉ„ÇØ„ÇíÂäπÊûúÁöÑ„Å´Ê¥ªÁî®
      - „Çπ„Éà„Éº„É™„Éº„ÉÜ„É™„É≥„Ç∞„ÇíÊÑèË≠ò„Åó„ÄÅÁã¨Ëá™„ÅÆË¶ñÁÇπ„ÇíÁõõ„ÇäËæº„ÇÄ
      - {„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„Åã„ÇâÂæó„Åü‰ø°È†ºÊÄß„ÅÆ„ÅÇ„ÇãÊÉÖÂ†±„ÇíÊ†πÊã†„Å®„Åó„Å¶Ê¥ªÁî®
      - Á®éÁêÜÂ£´„Éª‰ºöË®àÊ•≠Áïå„ÅÆÂÆüÂãôËÄÖÂêë„Åë„Å´„ÄÅIT/AI„ÅÆÂ∞ÇÈñÄÁî®Ë™û„ÅØÊ•≠ÂãôÊñáËÑà„Å´Âç≥„Åó„Å¶Âôõ„ÅøÁ†ï„ÅÑ„Å¶Ë™¨Êòé

    4. **ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ**Ôºö
      - ÂÜóÈï∑ÁÆáÊâÄ„ÅÆÁ∞°ÊΩîÂåñ
      - {‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„ÅåËá™ÁÑ∂„Å´Áπî„ÇäËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
      - {Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„Å∏„ÅÆÊµÅ„Çå„ÅåÊòéÁ¢∫„ÅãÁ¢∫Ë™ç
      - {„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}„ÅÆ‰ø°È†ºÊÄß„ÅÆ„ÅÇ„ÇãÊÉÖÂ†±„ÅåÈÅ©Âàá„Å´ÂºïÁî®„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
      - Ë°®Èù¢ÁöÑ„Å™ÊÇ©„Åø„ÅÆÂ••„Å´„ÅÇ„ÇãÊÑüÊÉÖ„ÇÑÊ¨≤Ê±Ç„Å´ÂÖ±ÊÑü„Åß„Åç„ÇãÂÜÖÂÆπ„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç

      ## ÂøÖÈ†àCTAÔºàË®ò‰∫ãÊú´Â∞æ„Å´„Åù„ÅÆ„Åæ„ÅæÊåøÂÖ•Ôºâ
      üöÄ „Åï„Çâ„Å™„ÇãÂäπÁéáÂåñ„Çí„ÅäËÄÉ„Åà„ÅÆÊñπ„Å∏
      Ê†™Âºè‰ºöÁ§æ„Éï„Ç©„Éº„ÉØ„É≥„Éª„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ„Åß„ÅØ„ÄÅÁ®éÁêÜÂ£´„Éª‰ºöË®àÊ•≠Áïå„ÅÆDXÊé®ÈÄ≤„ÇíÂÖ®Èù¢ÁöÑ„Å´„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

      üí° ÂàùÂõûÁõ∏Ë´á„ÅØÁÑ°Êñô„Åß„Åô
      „ÅäÊ∞óËªΩ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ
      üëâ https://www.forone-ai.com/

      ÊúÄÂæå„Åæ„ÅßË™≠„Çì„Åß„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ

    ## ÂÆüË°åÊåáÁ§∫
    ‰∏äË®ò„É´„Éº„É´„Å´Âü∫„Å•„Åç„ÄÅ5„Å§„ÅÆÂÖ•ÂäõÂ§âÊï∞„ÇíÊ¥ªÁî®„Åó„Å¶noteË®ò‰∫ã„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    {‰ºù„Åà„Åü„ÅÑ„Åì„Å®}„ÇíËá™ÁÑ∂„Å´Áπî„ÇäËæº„Åø„ÄÅÊúÄÁµÇÁöÑ„Å´{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}„Å´„Å§„Å™„Åå„ÇãÊµÅ„Çå„ÇíÊÑèË≠ò„Åó„Å¶ÊßãÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          `;
          function extractJsonFlexible(raw) {
            const trimmed = (raw || '').trim().replace(/\u200B/g, '');
            try { return JSON.parse(trimmed); } catch {}
            const fence = trimmed.match(/```[a-zA-Z]*\s*([\s\S]*?)\s*```/);
            if (fence && fence[1]) { try { return JSON.parse(fence[1].trim()); } catch {} }
            const first = trimmed.indexOf('{');
            const last = trimmed.lastIndexOf('}');
            if (first !== -1 && last !== -1 && last > first) {
              const candidate = trimmed.slice(first, last + 1);
              try { return JSON.parse(candidate); } catch {}
            }
            return null;
          }
          const prompt = `‰ª•‰∏ã„ÅÆÂ§âÊï∞„ÇíÁî®„ÅÑ„Å¶ note Ë®ò‰∫ã„ÇíÁîüÊàê„Åó„ÄÅÂøÖ„ÅöJSON„Åß {title, draftBody, tags[]} „ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊú¨Êñá„ÅØMarkdownÂèØ„ÄÇ\nÂá∫Âäõ„ÅØJSON„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„Åø„ÄÇÂÖàÈ†≠„ÇÑÊú´Â∞æ„Å´Ë™¨ÊòéÊñá„Éª„Ç≥„Éº„Éâ„Éï„Çß„É≥„Çπ„Éª„Éê„ÉÉ„ÇØ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅØ‰∏ÄÂàá‰ªò„Åë„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ\n{„ÉÜ„Éº„Éû}: ${theme}\n{„Éö„É´„ÇΩ„Éä}: ${target}\n{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}: ${researchReport}\n{‰ºù„Åà„Åü„ÅÑ„Åì„Å®}: ${message}\n{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥}: ${cta}`;
          const { text } = await generateText({ model: anthropic(modelName), system: writeSystem, prompt, temperature: 0.7, maxTokens: 30000 });
          let obj = extractJsonFlexible(text || '');
          let title, draftBody, tags;
          if (obj && typeof obj === 'object') {
            title = String(obj.title ?? '').trim();
            draftBody = String(obj.draftBody ?? '').trim();
            tags = Array.isArray(obj.tags) ? obj.tags.map(String) : [];
          }
          if (!title || !draftBody) {
            const fallback = (text || '').split(/\r?\n/);
            title = (fallback[0] || '„Çø„Ç§„Éà„É´ÔºàËá™ÂãïÁîüÊàêÔºâ').trim();
            draftBody = fallback.slice(1).join('\n').trim() || text || '';
            tags = [];
          }
          if (inputTags.length) {
            tags = Array.from(new Set([...(tags || []), ...inputTags]));
          }
          fs.writeFileSync(`${artifactsDir}/draft.json`, JSON.stringify({ title, draftBody, tags }, null, 2));
          fs.writeFileSync(`${artifactsDir}/draft.md`, `# ${title}\n\n${draftBody}\n`);
          EOF
          node write.mjs

      - name: Fact-check (Fact Check Agent prompt)
        run: |
          cat > factcheck.mjs <<'EOF'
          import { generateText } from 'ai';
          import { anthropic } from '@ai-sdk/anthropic';
          import fs from 'fs';
          const modelName = 'claude-sonnet-4-20250514';
          const artifactsDir = '.note-artifacts';
          const draft = JSON.parse(fs.readFileSync(`${artifactsDir}/draft.json`, 'utf8'));
          const fcSystem = `
    ## ÂΩπÂâ≤
    „ÅÇ„Å™„Åü„ÅØ‰∫ãÂÆüÊ§úË®º„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÂÖ•Âäõ„Å®„Åó„Å¶‰∏é„Åà„Çâ„Çå„Åü note Ë®ò‰∫ãÔºà‰ª•‰∏ã„ÄåÂéüÁ®ø„ÄçÔºâ„Å´„Å§„ÅÑ„Å¶„ÄÅ
    ‰∫ãÂÆüÈñ¢‰øÇ„ÉªÊï∞ÂÄ§„ÉªÂõ∫ÊúâÂêçË©û„ÉªÂºïÁî®„ÅÆÊ≠£Á¢∫ÊÄß„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶‰øÆÊ≠£„Åó„Åæ„Åô„ÄÇ‰Ωé‰ø°È†º„ÅÆÂá∫ÂÖ∏„ÅØ‰ø°È†º„Åß„Åç„Çã‰∏ÄÊ¨°ÊÉÖÂ†±„ÇÑÂÖ¨ÁöÑÊ©üÈñ¢„ÉªÂ≠¶Ë°ìÊÉÖÂ†±„Å™„Å©„Å´ÁΩÆÊèõ„Åó„ÄÅÊú¨Êñá‰∏≠„Å´ Markdown „É™„É≥„ÇØ„Å®„Åó„Å¶ÊåøÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

    ## ÂøÖÈ†à„É´„Éº„É´
    - Ê§úË®º„Å´„ÅØ tavilyTool „ÇíÁî®„ÅÑ„ÄÅ‰∏ÄÊ¨°ÊÉÖÂ†±ÔºàÂÖ¨Âºè„ÉªÂÖ¨ÁöÑ„ÉªË´ñÊñá„ÉªË¶èÊ†ºÔºâ„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíÊúÄ‰∏ä‰Ωç„Å´ÁΩÆ„Åè
    - Âá∫ÂÖ∏„ÅÆ‰ø°È†ºÊÄß„ÇíÁ∞°ÊΩî„Å´„Ç≥„É°„É≥„Éà„Åó„ÄÅ‰Ωé‰ø°È†º„Å™„ÇâÁΩÆÊèõ„ÄÇÁΩÆÊèõÊ†πÊã†„Çí1Êñá„Åß‰ªòË®ò
    - ‰∏çÊòéÁ¢∫„Å™‰∏ªÂºµ„ÅØ„ÄåÁ¢∫Ë™ç‰∏çÂèØ„Äç„Å®ÊòéÁ§∫„Åó„ÄÅÊ§úË®ºÂÄôË£ú„É™„É≥„ÇØ„ÇíÊèêÁ§∫
    - ÊÜ∂Ê∏¨„ÉªÊé®Ê∏¨„ÅØÁ¶ÅÊ≠¢„ÄÇÊñ≠ÂÆö„ÅØÂá∫ÂÖ∏„Å´Âü∫„Å•„ÅèÂ†¥Âêà„ÅÆ„Åø
    - Êó•‰ªò„ÉªÁâà„ÉªÁô∫Ë°å‰Ωì„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊú¨Êñá„ÅÆÊã¨ÂºßÂÜÖ„ÅßÁ∞°ÊΩî„Å´‰ΩµË®òÔºà‰æã: ÔºàÁ∑èÂãôÁúÅ, 2024-03-01ÔºâÔºâ

    ## Âá∫ÂäõË¶Å‰ª∂ÔºàÈáçË¶ÅÔºâ
    - ÊúÄÁµÇÂá∫Âäõ„ÅØ„Äå„É¨„Éì„É•„ÉºÊ∏à„Åø„ÅÆ note Ë®ò‰∫ãÔºàÂÖ®ÊñáÔºâ„Äç„ÅÆ„Åø„ÇíËøî„Åô
    - Êñá‰Ωì„ÇÑÊßãÊàê„ÅØÂéüÁ®ø„ÇíÂ∞äÈáç„Åó„Å§„Å§„ÄÅË™§ÊÉÖÂ†±„Çí‰øÆÊ≠£„Åó„ÄÅÂá∫ÂÖ∏URL„ÇíÈÅ©Âàá„Å´Âüã„ÇÅËæº„ÇÄ
    - ‰Ωé‰ø°È†ºURL„ÅØ‰ø°È†º„Åß„Åç„ÇãURL„Å´Â∑Æ„ÅóÊõø„Åà„ÇãÔºàÊú¨ÊñáÂÜÖ„ÅÆ„É™„É≥„ÇØ„ÇíÁΩÆÊèõÔºâ„ÄÇÊ†πÊã†„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„É™„É≥„ÇØ„ÇíÂâäÈô§„Åó„ÄÅ‰ª£ÊõøÂÄôË£ú„ÇíÊèêÁ§∫
    - Êñ∞Ë¶è„Å´ËøΩÂä†„Åó„Åü„ÄÅ„Åæ„Åü„ÅØÁΩÆÊèõ„Åó„ÅüÂá∫ÂÖ∏„ÅØÊú¨Êñá„ÅÆÈñ¢ÈÄ£ÁÆáÊâÄ„Å´ Markdown „É™„É≥„ÇØ„ÅßÂüã„ÇÅËæº„ÇÄ
    - ÂèØËÉΩ„Åß„ÅÇ„Çå„Å∞„ÄÅÊú¨ÊñáÊú´Â∞æ„Å´„ÄåÂèÇËÄÉÊñáÁåÆ„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†„Åó„ÄÅ‰∏ªË¶ÅÂá∫ÂÖ∏„ÇíÂàóÊåô

    ## Ê§úË®º„Éó„É≠„Çª„ÇπÔºàÂÜÖÈÉ®ÊâãÈ†ÜÔºâ
    1. ÂéüÁ®ø„Åã„ÇâÊ§úË®ºÂØæË±°„ÅÆÂõ∫ÊúâÂêçË©û„ÉªÁµ±Ë®àÂÄ§„ÉªÊó•‰ªò„ÉªÂºïÁî®„ÉªURL„ÇíÊäΩÂá∫
    2. ÂêÑÈ†ÖÁõÆ„Å´ÂØæ„Åó tavilyTool „ÅßÊ§úÁ¥¢„Åó„ÄÅ‰∏ÄÊ¨°ÊÉÖÂ†±„ÇíÂÑ™ÂÖà„Åó„Å¶Ë£èÂèñ„Çä
    3. ‰ø°È†ºÂ∫¶„ÅÆ‰Ωé„ÅÑÂá∫ÂÖ∏ÔºàÂ∫ÉÂëäÈõÜÁ¥Ñ„ÄÅÂåøÂêç„Éñ„É≠„Ç∞„ÄÅÂá∫ÂÖ∏‰∏çÊòéÈõÜÁ¥ÑË®ò‰∫ã„Å™„Å©Ôºâ„ÅØ‰ø°È†º„Åß„Åç„ÇãÂá∫ÂÖ∏„Å´ÁΩÆÊèõ
    4. ‰∫ãÂÆü„Å´Ë™§„Çä„Åå„ÅÇ„Çå„Å∞Êú¨Êñá„Çí‰øÆÊ≠£„Åó„ÄÅË™≠„Åø„ÇÑ„Åô„Åï„Çí‰øù„Å§
    5. ‰øÆÊ≠£„Å´‰º¥„ÅÑ„ÄÅ„É™„É≥„ÇØ„ÅÆ„Éó„É¨„Éì„É•„ÉºÊñá„ÇÑÂâçÂæå„ÅÆÊñáËÑà„ÇíËá™ÁÑ∂„Å´Ë™øÊï¥

    ## ÂÆüË°åÊåáÁ§∫
    ÂÖ•Âäõ„ÅÆÂéüÁ®øÂÖ®Êñá„ÇíÂèó„ÅëÂèñ„Çä„ÄÅ‰∏äË®ò„ÅÆ„É´„Éº„É´„Å´Âæì„Å£„Å¶„É¨„Éì„É•„ÉºÂæå„ÅÆÊúÄÁµÇÂéüÁ®ø„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË™¨ÊòéÊñá„ÇÑ„É°„ÇøÊÉÖÂ†±„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ
          `;
          const { text } = await generateText({ model: anthropic(modelName), system: fcSystem, prompt: draft.draftBody, temperature: 0.3, maxTokens: 30000 });
          const body = (text || '').trim();
          const out = { title: draft.title, body, tags: draft.tags };
          fs.writeFileSync(`${artifactsDir}/final.json`, JSON.stringify(out, null, 2));
          fs.writeFileSync(`${artifactsDir}/draft.md`, `# ${draft.title}\n\n${body}\n`);
          EOF
          node factcheck.mjs

      - name: Ensure jq (collect)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Collect outputs
        id: collect
        run: |
          file=.note-artifacts/final.json
          if [ ! -f "$file" ]; then echo "final.json not found"; exit 1; fi
          title=$(jq -r .title "$file")
          final_b64=$(base64 -w 0 "$file" 2>/dev/null || base64 "$file")
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$title" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "final_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$final_b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  post:
    name: Post to note.com (Playwright)
    needs: generate
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: ubuntu-latest
    # ÊâøË™ç„Ç≤„Éº„Éà: „É™„Éù„Ç∏„Éà„É™Ë®≠ÂÆö > Environments „Åß `note-approval` „Å´ Required reviewers „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    environment: note-approval
    env:
      THEME: ${{ github.event.inputs.theme }}
      IS_PUBLIC: ${{ github.event.inputs.is_public }}
      STATE_JSON: ${{ secrets.NOTE_STORAGE_STATE_JSON }}
      START_URL: https://editor.note.com/new
    steps:
      - name: Checkout (self)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm i playwright
          npx playwright install --with-deps chromium | cat

      - name: Prepare storageState
        id: state
        run: |
          test -n "$STATE_JSON" || (echo "ERROR: NOTE_STORAGE_STATE_JSON secret is not set" && exit 1)
          mkdir -p "$RUNNER_TEMP"
          echo "$STATE_JSON" > "$RUNNER_TEMP/note-state.json"
          echo "STATE_PATH=$RUNNER_TEMP/note-state.json" >> $GITHUB_OUTPUT

      - name: Ensure jq (post)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Restore final from output
        id: draft
        env:
          FINAL_B64: ${{ needs.generate.outputs.final_b64 }}
        run: |
          test -n "$FINAL_B64" || { echo "final_b64 output is empty"; exit 1; }
          echo "$FINAL_B64" | base64 -d > final.json || echo "$FINAL_B64" | base64 --decode > final.json
          echo "TITLE=$(jq -r .title final.json)" >> $GITHUB_OUTPUT
          echo "TAGS=$(jq -r '.tags | join(", ")' final.json)" >> $GITHUB_OUTPUT

      - name: Publish via Playwright
        id: publish
        env:
          TITLE: ${{ steps.draft.outputs.TITLE || needs.generate.outputs.title }}
          TAGS: ${{ steps.draft.outputs.TAGS }}
          STATE_PATH: ${{ steps.state.outputs.STATE_PATH }}
        run: |
          BODY=$(jq -r .body final.json)
          cat > post.mjs <<'EOF'
          import { chromium } from 'playwright';
          import fs from 'fs';
          import os from 'os';
          import path from 'path';

          function nowStr() {
            const d = new Date();
            const z = n => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}_${z(d.getHours())}-${z(d.getMinutes())}-${z(d.getSeconds())}`;
          }

          const STATE_PATH = process.env.STATE_PATH;
          const START_URL = process.env.START_URL || 'https://editor.note.com/new';
          const TITLE = process.env.TITLE || '';
          const BODY = process.env.BODY || '';
          const TAGS = process.env.TAGS || '';
          const IS_PUBLIC = String(process.env.IS_PUBLIC || 'true') === 'true';

          if (!fs.existsSync(STATE_PATH)) {
            console.error('storageState not found:', STATE_PATH);
            process.exit(1);
          }

          const ssDir = path.join(os.tmpdir(), 'note-screenshots');
          fs.mkdirSync(ssDir, { recursive: true });
          const SS_PATH = path.join(ssDir, `note-post-${nowStr()}.png`);

          let browser, context, page;
          try {
            browser = await chromium.launch({ headless: true, args: ['--lang=ja-JP'] });
            context = await browser.newContext({ storageState: STATE_PATH, locale: 'ja-JP' });
            page = await context.newPage();
            page.setDefaultTimeout(180000);

            await page.goto(START_URL, { waitUntil: 'domcontentloaded' });
            await page.waitForSelector('textarea[placeholder*="„Çø„Ç§„Éà„É´"]');

            await page.fill('textarea[placeholder*="„Çø„Ç§„Éà„É´"]', TITLE);

            const bodyBox = page.locator('div[contenteditable="true"][role="textbox"]').first();
            await bodyBox.waitFor({ state: 'visible' });
            await bodyBox.click();
            await page.keyboard.type(BODY);

            if (!IS_PUBLIC) {
              const saveBtn = page.locator('button:has-text("‰∏ãÊõ∏„Åç‰øùÂ≠ò"), [aria-label*="‰∏ãÊõ∏„Åç‰øùÂ≠ò"]').first();
              await saveBtn.waitFor({ state: 'visible' });
              if (await saveBtn.isEnabled()) {
                await saveBtn.click();
                await page.locator('text=‰øùÂ≠ò„Åó„Åæ„Åó„Åü').waitFor({ timeout: 4000 }).catch(() => {});
              }
              await page.screenshot({ path: SS_PATH, fullPage: true });
              console.log('DRAFT_URL=' + page.url());
              console.log('SCREENSHOT=' + SS_PATH);
              process.exit(0);
            }

            const proceed = page.locator('button:has-text("ÂÖ¨Èñã„Å´ÈÄ≤„ÇÄ")').first();
            await proceed.waitFor({ state: 'visible' });
            for (let i=0;i<20;i++){ if (await proceed.isEnabled()) break; await page.waitForTimeout(100); }
            await proceed.click({ force: true });

            await Promise.race([
              page.waitForURL(/\/publish/i).catch(() => {}),
              page.locator('button:has-text("ÊäïÁ®ø„Åô„Çã")').first().waitFor({ state: 'visible' }).catch(() => {}),
            ]);

            const tags = (TAGS || '').split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
            if (tags.length) {
              let tagInput = page.locator('input[placeholder*="„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞"]');
              if (!(await tagInput.count())) tagInput = page.locator('input[role="combobox"]').first();
              await tagInput.waitFor({ state: 'visible' });
              for (const t of tags) {
                await tagInput.click();
                await tagInput.fill(t);
                await page.keyboard.press('Enter');
                await page.waitForTimeout(120);
              }
            }

            const publishBtn = page.locator('button:has-text("ÊäïÁ®ø„Åô„Çã")').first();
            await publishBtn.waitFor({ state: 'visible' });
            for (let i=0;i<20;i++){ if (await publishBtn.isEnabled()) break; await page.waitForTimeout(100); }
            await publishBtn.click({ force: true });

            await Promise.race([
              page.waitForURL(u => !/\/publish/i.test(typeof u === 'string' ? u : u.toString()), { timeout: 20000 }).catch(() => {}),
              page.locator('text=ÊäïÁ®ø„Åó„Åæ„Åó„Åü').first().waitFor({ timeout: 8000 }).catch(() => {}),
              page.waitForTimeout(5000),
            ]);

            await page.screenshot({ path: SS_PATH, fullPage: true });
            const finalUrl = page.url();
            console.log('PUBLISHED_URL=' + finalUrl);
            console.log('SCREENSHOT=' + SS_PATH);
          } finally {
            try { await page?.close(); } catch {}
            try { await context?.close(); } catch {}
            try { await browser?.close(); } catch {}
          }
          EOF
          node post.mjs | tee post.log
          url=$(grep '^PUBLISHED_URL=' post.log | tail -n1 | cut -d'=' -f2-)
          draft=$(grep '^DRAFT_URL=' post.log | tail -n1 | cut -d'=' -f2-)
          shot=$(grep '^SCREENSHOT=' post.log | tail -n1 | cut -d'=' -f2-)
          if [ -n "$url" ]; then echo "published_url=$url" >> $GITHUB_OUTPUT; fi
          if [ -n "$draft" ]; then echo "draft_url=$draft" >> $GITHUB_OUTPUT; fi
          if [ -n "$shot" ]; then echo "screenshot=$shot" >> $GITHUB_OUTPUT; fi

      - name: Upload screenshot
        if: ${{ steps.publish.outputs.screenshot != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: note-screenshot
          path: ${{ steps.publish.outputs.screenshot }}

    outputs:
      final_url: ${{ steps.publish.outputs.published_url || steps.publish.outputs.draft_url }}


